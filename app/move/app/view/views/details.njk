{% extends "./_layout.njk" %}

{% block customGtagConfig %}
  gtag('set', {'page_title': 'Details – Move'});
{% endblock %}

{% block pageTitle %}
  {{ getPageTitle() | join(' – ') if getPageTitle }}
{% endblock %}

{% macro _renderAssessmentComponent(assessment) %}
  {% if assessment.count > 0 %}
    {{ govukSummaryList(assessment) }}
  {% else %}
    {{ appMessage({
      classes: "app-message--muted govuk-!-margin-top-2",
      allowDismiss: false,
      content: {
        classes: "govuk-!-font-size-16",
        html: t('assessment::no_items.text', {
          context: assessment.context or assessment.key,
          name: assessment.name,
          url: assessment.url
        })
      }
    }) }}
  {% endif %}
{% endmacro %}

{% macro _section(heading) %}
  <section class="app-!-position-relative govuk-!-margin-top-7">
    {% if heading %}
      <h2 class="govuk-heading-m govuk-!-margin-bottom-0 govuk-!-padding-bottom-3 govuk-!-padding-right-8 app-border-bottom-1">
        {{ heading }}
      </h2>
    {% endif %}

    {{ caller() if caller else content }}
  </section>
{% endmacro %}

{% macro _updateLink(link) %}
  {% if link.href %}
    <p class="govuk-!-font-size-16 app-!-position-top-right">
      <a href="{{ link.href }}" class="govuk-link" {%- for attribute, value in link.attributes %} {{attribute}}="{{value}}"{% endfor %}>
        {{ link.html | safe }}
      </a>
    </p>
  {% endif %}
{% endmacro %}

{% block tabContent %}
  {% if (isAllocationMove) %}
    {# TODO: Get moves returned as part of an allocation so that we can determine the number #}
    {{ govukInsetText({
      html: t("messages::cancel_allocation_move.content", {
        context: "with_link" if canAccess("allocations:view"),
        count: allocation.moves.length or allocation.moves_count,
        href: "/allocation/" + allocation.id
      }),
      classes: "govuk-!-margin-bottom-0"
    }) }}
  {% endif %}

  {% call _section("Move overview") %}
    {{ govukSummaryList(moveSummary) }}
  {% endcall %}

  {% for section in sections.editable %}
    {% call _section(section.heading) %}
      {{ _renderAssessmentComponent(section) }}

      {% if isEditable %}
        {{ _updateLink(updateLinks[section.key]) }}
      {% endif %}
    {% endcall %}
  {% endfor %}

  {% if hasYouthRiskAssessment or hasPersonEscortRecord %}
    <div class="govuk-!-margin-top-5">
      {% if canAccess("youth_risk_assessment:view") and hasYouthRiskAssessment %}
        <p class="govuk-!-font-size-16 govuk-!-margin-bottom-2">
          <a href="/move/{{moveId}}/youth-risk-assessment">
            {{ t("actions::view_assessment", {
              context: "youth_risk_assessment"
            }) }}
          </a>
        </p>
      {% endif %}

      {% if canAccess("person_escort_record:view") and hasPersonEscortRecord %}
        <p class="govuk-!-font-size-16">
          <a href="/move/{{moveId}}/person-escort-record">
            {{ t("actions::view_assessment", {
              context: "person_escort_record"
            }) }}
          </a>
        </p>
      {% endif %}
    </div>
  {% endif %}

  {% if sections.uneditable %}
    {% set detailsHtml %}
      {{ govukWarningText({
        html: t("assessment::locked", {
          context: "request_information"
        }),
        iconFallbackText: "Warning"
      }) }}

      {% for section in sections.uneditable %}
        {% call _section(section.heading) %}
          {{ _renderAssessmentComponent(section) }}
        {% endcall %}
      {% endfor %}
    {% endset %}

    {{ govukDetails({
      classes: "govuk-!-font-size-16 govuk-!-margin-top-7",
      summaryText:t("assessment::view_previous_assessment", {
        context: "risk_and_health"
      }),
      html: detailsHtml
    }) }}
  {% endif %}
{% endblock %}
