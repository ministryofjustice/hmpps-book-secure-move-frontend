version: 2.1
orbs:
  browser-tools: circleci/browser-tools@1.4.1
  slack: circleci/slack@4.12.1
  hmpps: ministryofjustice/hmpps@7.2.1
  kubernetes: circleci/kubernetes@1.3.1
aliases:
  # Shared containers
  - &node_container
    executor:
      name: hmpps/node
      tag: 18.14-browsers
  # Common steps
  - &install_dependencies
    run:
      name: Install NPM dependencies
      command: npm install && npm rebuild node-sass
  - &restore_cache
    restore_cache:
      name: Restore NPM cache
      key: dependency-cache-{{ checksum "package.json" }}
  - &save_cache
    save_cache:
      name: Save NPM cache
      key: dependency-cache-{{ checksum "package.json" }}
      paths:
        - ./node_modules
  - &set_package_version
    run:
      name: Set version
      command: |
        echo "export PACKAGE_VERSION=$(grep -m1 version package.json | awk -F: '{ print $2 }' | sed 's/[", ]//g')" >> $BASH_ENV
  # Common filters
  - &only_main
    filters:
      branches:
        only:
          - main

jobs:
  build:
    <<: *node_container
    steps:
      - checkout
      - *set_package_version
      - *restore_cache
      - *install_dependencies
      - *save_cache
      - run:
          name: Compile typescript
          command: npx tsc --project ./
      - run:
          name: Build assets and frameworks
          command: npm run build
      - persist_to_workspace:
          root: .
          paths: 
            - .
  lint:
    <<: *node_container
    steps:
      - attach_workspace:
          at: .
      - checkout    
      - run:
          name: Lint the code
          command: npm run circle:lint
      #Can't lint helm until we have charts
      #- hmpps/helm_lint

  unit-test:
    <<: *node_container
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run unit tests
          command: |
            npm run circle:coverage
      - store_test_results:
          path: reports
      - store_artifacts:
          path: reports
      - run:
          name: Compress Coverage
          command: tar -cvzf coverage.tar coverage
      - store_artifacts:
          path: coverage.tar

  end-to-end-test:
    <<: *node_container
    resource_class: large
    parallelism: 8
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: .
      - browser-tools/install-browser-tools
      - run:
          name: Run E2E tests (same instance)
          environment:
            REDIS_URL: ""
            NODE_OPTIONS: --max-old-space-size=12288
          command: |
            npm run test-e2e -- --test $(circleci tests glob "test/e2e/**/*.test.js" | circleci tests split --split-by=timings)
      - run:
          name: Convert testcafe reports to relative path
          command: sed -i 's/\/home\/circleci\/project\///g' reports/testcafe/*.xml
      - store_test_results:
          path: reports/testcafe
      - store_artifacts:
          path: ~/app/artifacts
      - *notify_slack_on_failure

  publish-release-to-sentry:
    <<: *node_container
    parameters:
      sentry_env:
        type: string
    steps:
      - checkout
      - run:
          name: Create release and notify Sentry of deploy
          command: |
            curl -sL https://sentry.io/get-cli/ | bash
            export SENTRY_RELEASE=$(sentry-cli releases propose-version)
            sentry-cli releases new -p $SENTRY_PROJECT $SENTRY_RELEASE
            sentry-cli releases set-commits $SENTRY_RELEASE --auto
            sentry-cli releases finalize $SENTRY_RELEASE
            sentry-cli releases deploys $SENTRY_RELEASE new -e $SENTRY_ENVIRONMENT
          environment:
            SENTRY_ENVIRONMENT: <<parameters.sentry_env>>

  test-build-docker-image:
    <<: *node_container
    steps:
      - checkout
      - *set_package_version
      - *install_dependencies
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Compile typescript
          command: npx tsc --project ./
      - run:
          name: Build docker image
          command: |
            export BUILD_DATE=$(date -Is) >> $BASH_ENV
            source $BASH_ENV

            docker build \
              --label build.git.sha=${CIRCLE_SHA1} \
              --label build.git.branch=${CIRCLE_BRANCH} \
              --label build.date=${BUILD_DATE} \
              --build-arg APP_BUILD_DATE=${BUILD_DATE} \
              --build-arg APP_BUILD_TAG=${CIRCLE_BUILD_NUM} \
              --build-arg APP_GIT_COMMIT=${CIRCLE_SHA1} \
              --build-arg APP_BUILD_BRANCH=${CIRCLE_BRANCH} \
              -t app .
  build-docker-image:
    <<: *node_container
    steps:
      - checkout
      - *set_package_version
      - *install_dependencies
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Compile typescript
          command: npx tsc --project ./
      - run:
          name: Build docker image
          command: |
            export BUILD_DATE=$(date -Is) >> $BASH_ENV
            source $BASH_ENV

            docker build \
              --label build.git.sha=${CIRCLE_SHA1} \
              --label build.git.branch=${CIRCLE_BRANCH} \
              --label build.date=${BUILD_DATE} \
              --build-arg APP_BUILD_DATE=${BUILD_DATE} \
              --build-arg APP_BUILD_TAG=${CIRCLE_BUILD_NUM} \
              --build-arg APP_GIT_COMMIT=${CIRCLE_SHA1} \
              --build-arg APP_BUILD_BRANCH=${CIRCLE_BRANCH} \
              -t app .
      - run:
          name: Push docker image to Quay
          command: |
            docker login -u="${QUAYIO_USERNAME}" -p="${QUAYIO_PASSWORD}" quay.io
            docker tag app "quay.io/hmpps/${CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1}"
            docker push "quay.io/hmpps/${CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1}"
  deploy:
    executor:
      name: hmpps/default_small
      tag: "3.10"
    parameters:
      env:
        type: string
      cluster:
        type: string
        default: "live"
      notify_slack:
        type: string
        default: ""
    steps:
      - checkout
      - *set_package_version
      - export_kube_vars:
          env: << parameters.env >>
          cluster: << parameters.cluster >>
      - kubernetes/install
      - run:
          name: Authenticate with cluster
          command: |
            echo -n $KUBE_CACERT | base64 -d > ./ca.crt
            kubectl config set-cluster ${KUBE_CLUSTER} --certificate-authority=./ca.crt --server=https://${KUBE_CLUSTER}
            kubectl config set-credentials circleci --token=${KUBE_TOKEN}
            kubectl config set-context ${KUBE_CLUSTER} --cluster=${KUBE_CLUSTER} --user=circleci --namespace=${KUBE_NAMESPACE}
            kubectl config use-context ${KUBE_CLUSTER}
      - deploy:
          name: Deploy image to << parameters.env >> on << parameters.cluster >> cluster
          command: |
            export BUILD_DATE=$(date -Is) >> $BASH_ENV
            source $BASH_ENV

            kubectl set image -n hmpps-book-secure-move-frontend-<< parameters.env >> \
                    deployment/hmpps-book-secure-move-frontend-deployment-<< parameters.env >> \
                    webapp="quay.io/hmpps/${CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1}"

            kubectl annotate -n hmpps-book-secure-move-frontend-<< parameters.env >> \
                    deployment/hmpps-book-secure-move-frontend-deployment-<< parameters.env >> \
                    kubernetes.io/change-cause="${BUILD_DATE} set image ${CIRCLE_PROJECT_REPONAME}:${CIRCLE_SHA1} via CircleCI"
      - when:
          condition: <<parameters.notify_slack>>
          steps:
            - *notify_slack_on_release_end

workflows:
  continuous-deployment:
    jobs:
      # Tests
      - build
      - lint:
          requires:
            - build
      - unit-test:
          requires:
            - build
      - end-to-end-test:
          name: end-to-end-test
          requires:
            - build
      - hmpps/build_docker:
          <<: *only_main
          name: build-docker-image
          requires:
            - build
      # Deployment
      - hmpps/deploy_env:
          <<: *only_main
          name: deploy-staging
          env: 'staging'
          requires:
            - build-docker-image
            - end-to-end-test
            - lint
      - hmpps/deploy_env:
          <<: *only_main
          name: deploy-preprod
          env: 'preprod'
          requires:
            - preprod-approval
      - hmpps/deploy_env:
          <<: *only_main
          name: deploy-uat
          env: 'uat'
          requires:
            - uat-approval
      - hmpps/deploy_env:
          <<: *only_main
          name: deploy-production
          env: 'production'
          slack_notification: true
          slack_channel_name: pecs-dev
          requires:
            - prod-approval

      # Approval gates
      - uat-approval:
          type: approval
          requires:
            - deploy-staging
      - preprod-approval:
          type: approval
          requires:
            - deploy-staging
      - prod-approval:
          type: approval
          requires:
            - deploy-preprod
            - deploy-uat

      # Post release
      - hmpps/sentry_release_and_deploy:
          <<: *only_main
          name: publish-release-to-sentry-staging
          sentry_project: book-a-secure-move-frontend
          sentry_environment: staging
          sentry_create_release: true
          requires:
            - deploy-staging
      - hmpps/sentry_release_and_deploy:
          <<: *only_main
          name: publish-release-to-sentry-uat
          sentry_project: book-a-secure-move-frontend
          sentry_environment: uat
          requires:
            - deploy-uat
      - hmpps/sentry_release_and_deploy:
          <<: *only_main
          name: publish-release-to-sentry-preprod
          sentry_project: book-a-secure-move-frontend
          sentry_environment: preproduction
          requires:
            - deploy-preprod
      - hmpps/sentry_release_and_deploy:
          <<: *only_main
          name: publish-release-to-sentry-production
          sentry_project: book-a-secure-move-frontend
          sentry_environment: production
          requires:
            - deploy-production
